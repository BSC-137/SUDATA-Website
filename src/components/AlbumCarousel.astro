---
// This code is pretty poor.
// I don't understand any of Astro's quirks, I only know the solution (docs came in clutch)
import { Image } from "astro:assets";

type Props = {
  title?: string;
  description?: string;
  images: Array<{ src: any; alt?: string }>;
  height?: number;
};

const { title = "", description = "Tap to view!", images, height = 420 } = Astro.props;

const uid = `carousel-${Math.random().toString(36).slice(2)}`;
---

<div class="album-glow">
  <div class="album-card w-full max-w-3xl rounded-xl overflow-hidden" id={uid} data-carousel-root>
    <!-- Uncomment for little headers on each album -->
    <!-- <div class="pa-like-header px-4 py-3">
      {title && <div class="font-semibold">{title}</div>}
      <div class="text-sm text-sudata-grey">{description}</div>
    </div> -->

    <div class="relative">
      <div class="carousel" style={`height:${height}px`} data-carousel>
        {images.map((img, i) => (
          <div class="slide" data-slide>
            <Image
              src={img.src}
              alt={img.alt ?? ""}
              loading={i === 0 ? "eager" : "lazy"}
              decoding="async"
              class="h-full w-full object-contain"
              widths={[640, 800, 1200, 1600]}
              sizes="(max-width: 768px) 100vw, 768px"
            />
          </div>
        ))}
      </div>

      <button class="nav left" type="button" data-prev aria-label="Previous">‹</button>
      <button class="nav right" type="button" data-next aria-label="Next">›</button>

      <div class="dots" data-dots>
        <!-- moving active indicator -->
        <span class="dot-indicator" aria-hidden="true">
          <span class="dot-indicator-dot"></span>
        </span>

        {images.map((_, i) => (
          <button class="dot" type="button" data-dot={i} aria-label={`Go to slide ${i + 1}`} />
        ))}
      </div>
    </div>
  </div>
</div>

<style>
  :root {
    /* tweak this based on what others think of it */
    --neon-glow: 204, 0, 255;
  }

  .album-card {
    border: 1px solid rgba(0, 255, 255, 0.18);
    background: rgba(10, 20, 40, 0.55);
    box-shadow:
      0 0 0 1px rgba(0, 255, 255, 0.10) inset,
      0 0 28px rgba(var(--neon-glow), 0.10),
      0 0 90px rgba(var(--neon-glow), 0.06);

    border-color: rgba(0, 255, 255, 0.18);
    transform: translateY(0);

    transition:
      box-shadow 520ms cubic-bezier(0.2, 0.8, 0.2, 1),
      border-color 420ms ease,
      transform 220ms ease;
    will-change: box-shadow, transform;
  }

  .album-card:hover {
    border-color: rgba(0, 255, 255, 0.24);
    box-shadow:
      0 0 0 1px rgba(var(--neon-glow), 0.12) inset,
      0 0 32px rgba(var(--neon-glow), 0.13),
      0 0 110px rgba(var(--neon-glow), 0.08);
    transform: translateY(-1px) rotateX(2.6deg) rotateY(-2.6deg);
  }

  .pa-like-header {
    background: rgba(10, 20, 40, 0.55);
    border-bottom: 1px solid rgba(0, 255, 255, 0.12);
  }

  .carousel {
    display: flex;
    overflow-x: auto;
    scroll-snap-type: x mandatory;
    scroll-behavior: smooth;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
  }
  .carousel::-webkit-scrollbar { display: none; }

  .slide {
    flex: 0 0 100%;
    scroll-snap-align: center;
    background: rgba(0, 0, 0, 0.35);
  }

  .nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 42px;
    height: 42px;
    border-radius: 999px;
    border: 1px solid rgba(0, 255, 255, 0.25);
    background: rgba(10, 20, 40, 0.55);
    color: white;
    font-size: 28px;
    line-height: 1;
    display: grid;
    place-items: center;
    cursor: pointer;
    user-select: none;
    z-index: 10;

    transition: transform 120ms ease, border-color 180ms ease, background 180ms ease, box-shadow 220ms ease;
    pointer-events: auto;
  }
  .nav:hover {
    border-color: rgba(0, 255, 255, 0.45);
    transform: translateY(-50%) scale(1.04);
    box-shadow: 0 0 16px rgba(0, 255, 255, 0.18);
  }
  .nav.left { left: 10px; }
  .nav.right { right: 10px; }
  .nav:active { transform: translateY(-50%) scale(0.96); }
  .nav:focus-visible { outline: 2px solid rgba(0,255,255,0.55); outline-offset: 3px; }

  .dots {
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    bottom: 10px;
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 10px;
    border-radius: 999px;
    background: rgba(10, 20, 40, 0.45);
    border: 1px solid rgba(0, 255, 255, 0.15);
    z-index: 10;
  }

  .dot {
    width: 8px;
    height: 8px;
    border-radius: 999px;
    border: 0;
    background: rgba(255, 255, 255, 0.45);
    cursor: pointer;
    position: relative;
    z-index: 2;
    transition: transform 120ms ease, background 160ms ease;
  }

  .dot:hover  { transform: scale(1.25); }
  .dot:active { transform: scale(0.9); }

  /* don't style active dot; indicator is the active marker */
  .dot[data-active="true"] {
    background: rgba(255, 255, 255, 0.45);
    transform: none;
  }

  /* Moving indicator: positioned by JS, sits on TOP so it covers the white dot */
  .dot-indicator {
    position: absolute;
    top: 50%;
    left: 0;
    transform: translate3d(0, -50%, 0);
    pointer-events: none;
    z-index: 5;

    width: 8px;
    height: 8px;

    will-change: transform;
  }

  .dot-indicator-dot {
    display: block;
    width: 8px;
    height: 8px;
    border-radius: 999px;
    background: rgba(0, 255, 255, 0.95);

    transform: scale(1.35); /* bigger at rest */
    transform-origin: center;
    transition: transform 140ms ease;
  }

  /* shrink while moving */
  .dot-indicator.is-moving .dot-indicator-dot {
    transform: scale(0.75);
  }

  /* pop when it settles */
  .dot-indicator.is-pop .dot-indicator-dot {
    animation: dot-pop 200ms cubic-bezier(0.2, 0.9, 0.2, 1);
  }

  @keyframes dot-pop {
    0%   { transform: scale(0.95); }
    60%  { transform: scale(1.55); }
    100% { transform: scale(1.35); }
  }
</style>

<script is:inline>
  function initCarousel(root) {
    if (root.dataset.carouselInited === "true") return;
    root.dataset.carouselInited = "true";

    const track = root.querySelector("[data-carousel]");
    const slides = Array.from(root.querySelectorAll("[data-slide]"));
    const dots = Array.from(root.querySelectorAll("[data-dot]"));
    const dotsWrap = root.querySelector("[data-dots]");
    const indicator = dotsWrap?.querySelector(".dot-indicator");

    if (!track || slides.length === 0 || !dotsWrap || !indicator || dots.length === 0) return;

    const prefersReduced = window.matchMedia?.("(prefers-reduced-motion: reduce)")?.matches;

    const clamp = (n, lo, hi) => Math.max(lo, Math.min(hi, n));

    const getIndex = () => {
      const w = track.clientWidth || 1;
      return clamp(Math.round(track.scrollLeft / w), 0, slides.length - 1);
    };

    const setDotsActive = (idx) => {
      dots.forEach((d, i) => (d.dataset.active = String(i === idx)));
    };

    // Dot centers relative to dots wrapper
    let centers = [];
    const recomputeCenters = () => {
      const wrapRect = dotsWrap.getBoundingClientRect();
      centers = dots.map((d) => {
        const r = d.getBoundingClientRect();
        return (r.left - wrapRect.left) + r.width / 2;
      });
    };

    // Place indicator at fractional progress t (0..n-1)
    const setIndicatorProgress = (t) => {
      if (!centers.length) return;
      const n = centers.length;
      const clampedT = Math.max(0, Math.min(n - 1, t));

      const i0 = Math.floor(clampedT);
      const i1 = Math.min(i0 + 1, n - 1);
      const frac = clampedT - i0;

      const center = centers[i0] * (1 - frac) + centers[i1] * frac;
      const x = center - indicator.offsetWidth / 2;

      // follow scroll exactly (no extra easing; scrollTo smooth already eases)
      indicator.style.transition = "none";
      indicator.style.transform = `translate3d(${x}px, -50%, 0)`;
    };

    // moving + settle detection
    let scrollEndTimer = null;
    let popTimer = null;

    const markMoving = () => {
      if (prefersReduced) return;

      indicator.classList.add("is-moving");
      indicator.classList.remove("is-pop");

      clearTimeout(scrollEndTimer);
      scrollEndTimer = setTimeout(() => {
        indicator.classList.remove("is-moving");
        indicator.classList.add("is-pop");
        clearTimeout(popTimer);
        popTimer = setTimeout(() => indicator.classList.remove("is-pop"), 220);
      }, 120);
    };

    const goTo = (idx) => {
      const current = getIndex();
      const next = clamp(idx, 0, slides.length - 1);
      if (next === current) return; // prevents "end bump" animation

      markMoving();
      const w = track.clientWidth || 1;
      track.scrollTo({ left: next * w, behavior: "smooth" });
    };

    // buttons
    root.querySelector("[data-prev]")?.addEventListener("click", (e) => {
      e.preventDefault();
      goTo(getIndex() - 1);
    });

    root.querySelector("[data-next]")?.addEventListener("click", (e) => {
      e.preventDefault();
      goTo(getIndex() + 1);
    });

    // dot clicks
    dots.forEach((d) => {
      d.addEventListener("click", (e) => {
        e.preventDefault();
        goTo(Number(d.dataset.dot));
      });
    });

    // scroll drives indicator smoothly between dots (touch swipe + smooth scrollTo)
    const onScroll = () => {
      const w = track.clientWidth || 1;
      const t = track.scrollLeft / w;

      setIndicatorProgress(t);
      setDotsActive(clamp(Math.round(t), 0, slides.length - 1));
      markMoving();
    };

    track.addEventListener("scroll", onScroll, { passive: true });

    // resize: recompute centers + reposition
    new ResizeObserver(() => {
      recomputeCenters();
      const w = track.clientWidth || 1;
      setIndicatorProgress(track.scrollLeft / w);
      setDotsActive(getIndex());
    }).observe(track);

    // init
    recomputeCenters();
    setIndicatorProgress(0);
    setDotsActive(0);
  }

  function initAllCarousels() {
    document.querySelectorAll("[data-carousel-root]").forEach(initCarousel);
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initAllCarousels, { once: true });
  } else {
    initAllCarousels();
  }

  document.addEventListener("astro:page-load", initAllCarousels);
</script>
