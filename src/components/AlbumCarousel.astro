---
// This code is pretty poor.
// I don't understand any of Astro's quirks, I only know the solution (docs came in clutch)
import { Image } from "astro:assets";

type Props = {
  title?: string;
  description?: string;
  images: Array<{ src: any; alt?: string }>;
  height?: number;
};

const { title = "", description = "Tap to view!", images, height = 420 } = Astro.props;

const uid = `carousel-${Math.random().toString(36).slice(2)}`;
---

<div class="album-glow">
  <div class="album-card w-full max-w-3xl rounded-xl overflow-hidden" id={uid} data-carousel-root>
    <!-- Uncomment for little headers on each album -->
    <!-- <div class="pa-like-header px-4 py-3">
      {title && <div class="font-semibold">{title}</div>}
      <div class="text-sm text-sudata-grey">{description}</div>
    </div> -->

    <div class="relative">
      <div class="carousel" style={`height:${height}px`} data-carousel>
        {images.map((img, i) => (
          <div class="slide" data-slide>
            <Image
              src={img.src}
              alt={img.alt ?? ""}
              loading={i === 0 ? "eager" : "lazy"}
              decoding="async"
              class="h-full w-full object-contain"
              widths={[640, 800, 1200, 1600]}
              sizes="(max-width: 768px) 100vw, 768px"
            />
          </div>
        ))}
      </div>

      <button class="nav left" type="button" data-prev aria-label="Previous">‹</button>
      <button class="nav right" type="button" data-next aria-label="Next">›</button>

      <div class="dots" data-dots>
        {images.map((_, i) => (
          <button class="dot" type="button" data-dot={i} aria-label={`Go to slide ${i + 1}`} />
        ))}
      </div>
    </div>
  </div>
</div>


<style>
  :root {
    /* tweak this based on what others think of it */
    --neon-glow: 204, 0, 255;
  }

  .album-card {
    border: 1px solid rgba(0, 255, 255, 0.18);
    background: rgba(10, 20, 40, 0.55);
    box-shadow:
      0 0 0 1px rgba(0, 255, 255, 0.10) inset,
      0 0 28px rgba(var(--neon-glow), 0.10),
      0 0 90px rgba(var(--neon-glow), 0.06);

    border-color: rgba(0, 255, 255, 0.18);
    transform: translateY(0);

    /* smooth interpolation */
    transition:
      box-shadow 520ms cubic-bezier(0.2, 0.8, 0.2, 1),
      border-color 420ms ease,
      transform 220ms ease;
    will-change: box-shadow, transform;
  }

  .album-card:hover {
    border-color: rgba(0, 255, 255, 0.24);
    box-shadow:
      0 0 0 1px rgba(var(--neon-glow), 0.12) inset,
      0 0 32px rgba(var(--neon-glow), 0.13),
      0 0 110px rgba(var(--neon-glow), 0.08);
    transform: translateY(-1px);
  }

  .pa-like-header {
    background: rgba(10, 20, 40, 0.55);
    border-bottom: 1px solid rgba(0, 255, 255, 0.12);
  }

  .carousel {
    display: flex;
    overflow-x: auto;
    scroll-snap-type: x mandatory;
    scroll-behavior: smooth;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
  }
  .carousel::-webkit-scrollbar { display: none; }

  .slide { 
    flex: 0 0 100%; 
    scroll-snap-align: center; 
    background: rgba(0, 0, 0, 0.35)
  }

  .nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 42px;
    height: 42px;
    border-radius: 999px;
    border: 1px solid rgba(0, 255, 255, 0.25);
    background: rgba(10, 20, 40, 0.55);
    color: white;
    font-size: 28px;
    line-height: 1;
    display: grid;
    place-items: center;
    cursor: pointer;
    user-select: none;
    z-index: 10;

    /* important to ensur clicks register even if an image overlays */
    pointer-events: auto;
  }
  .nav:hover { border-color: rgba(0, 255, 255, 0.45); }
  .nav.left { left: 10px; }
  .nav.right { right: 10px; }

  .dots {
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    bottom: 10px;
    display: flex;
    gap: 8px;
    padding: 8px 10px;
    border-radius: 999px;
    background: rgba(10, 20, 40, 0.45);
    border: 1px solid rgba(0, 255, 255, 0.15);
    z-index: 10;
  }
  .dot {
    width: 8px;
    height: 8px;
    border-radius: 999px;
    border: 0;
    background: rgba(255, 255, 255, 0.45);
    cursor: pointer;
  }
  .dot[data-active="true"] { background: rgba(0, 255, 255, 0.9); }
</style>

<script is:inline>
  function initCarousel(root) {
    root.dataset.carouselInited = "true";

    const track = root.querySelector("[data-carousel]");
    const slides = Array.from(root.querySelectorAll("[data-slide]"));
    const dots = Array.from(root.querySelectorAll("[data-dot]"));

    if (!track || slides.length === 0) return;

    const clamp = (n, lo, hi) => Math.max(lo, Math.min(hi, n));

    const getIndex = () => {
      const w = track.clientWidth || 1;
      return clamp(Math.round(track.scrollLeft / w), 0, slides.length - 1);
    };

    const setActiveDot = (idx) => {
      dots.forEach((d, i) => (d.dataset.active = String(i === idx)));
    };

    const goTo = (idx) => {
      const w = track.clientWidth || 1;
      const next = clamp(idx, 0, slides.length - 1);
      track.scrollTo({ left: next * w, behavior: "smooth" });
      setActiveDot(next);
    };

    root.querySelector("[data-prev]")?.addEventListener("click", (e) => {
      e.preventDefault();
      goTo(getIndex() - 1);
    });

    root.querySelector("[data-next]")?.addEventListener("click", (e) => {
      e.preventDefault();
      goTo(getIndex() + 1);
    });

    dots.forEach((d) => {
      d.addEventListener("click", (e) => {
        e.preventDefault();
        goTo(Number(d.dataset.dot));
      });
    });

    track.addEventListener(
      "scroll",
      () => setActiveDot(getIndex()),
      { passive: true }
    );

    // keep dot correct after resize
    new ResizeObserver(() => setActiveDot(getIndex())).observe(track);

    setActiveDot(0);
  }
  
  function initAllCarousels() {
    document.querySelectorAll("[data-carousel-root]").forEach(initCarousel);
  }

  // This is for buttons (without it you can't navigate each album)
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initAllCarousels, { once: true });
  } else {
    initAllCarousels();
  }

  // initialise carousels on page load
  document.addEventListener("astro:page-load", initAllCarousels);
</script>
